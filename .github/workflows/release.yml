name: Release Images

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g., v1.0.0)"
        required: true
        type: string

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  HUB_AGENT_IMAGE_NAME: hub-agent
  MEMBER_AGENT_IMAGE_NAME: member-agent
  REFRESH_TOKEN_IMAGE_NAME: refresh-token
  GO_VERSION: "1.24.13"

jobs:
  export-registry:
    uses: ./.github/workflows/setup-release.yml
    with:
      tag: ${{ inputs.tag || github.ref_name }}

  build-and-publish:
    needs: export-registry
    env:
      REGISTRY: ${{ needs.export-registry.outputs.registry }}
      TAG: ${{ needs.export-registry.outputs.tag }}
    runs-on: ubuntu-latest
    steps:
      - name: Set up Go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Checkout code
        uses: actions/checkout@v6.0.2

      - name: Login to ghcr.io
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push images with tag ${{ env.TAG }}
        run: |
          make push

      - name: Verify images
        run: |
          echo "âœ… Published images:"
          echo "  - ${{ env.REGISTRY }}/${{ env.HUB_AGENT_IMAGE_NAME }}:${{ env.TAG }}"
          echo "  - ${{ env.REGISTRY }}/${{ env.MEMBER_AGENT_IMAGE_NAME }}:${{ env.TAG }}"
          echo "  - ${{ env.REGISTRY }}/${{ env.REFRESH_TOKEN_IMAGE_NAME }}:${{ env.TAG }}"
