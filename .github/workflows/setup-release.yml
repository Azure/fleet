name: Setup Release

on:
    workflow_call:
        inputs:
            tag:
                description: "Release tag (e.g., v1.0.0)"
                required: true
                type: string
        outputs:
            registry:
                description: "OCI registry repository path (e.g., ghcr.io/org/repo)"
                value: ${{ jobs.export.outputs.registry }}
            tag:
                description: "Release tag (e.g., v1.0.0)"
                value: ${{ jobs.export.outputs.tag }}
            version:
                description: "Release version without v prefix (e.g., 1.0.0)"
                value: ${{ jobs.export.outputs.version }}

env:
    REGISTRY: ghcr.io

jobs:
    export:
        runs-on: ubuntu-latest
        outputs:
            registry: ${{ steps.setup.outputs.registry }}
            tag: ${{ steps.setup.outputs.tag }}
            version: ${{ steps.setup.outputs.version }}
        steps:
            - id: setup
              run: |
                  TAG="${{ inputs.tag }}"
                  if [[ ! "${TAG}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
                    echo "Error: Invalid release tag '${TAG}'. Expected format: v*.*.*"
                    exit 1
                  fi

                  # registry must be in lowercase
                  echo "registry=$(echo "${{ env.REGISTRY }}/${{ github.repository }}" | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
                  echo "tag=${TAG}" >> $GITHUB_OUTPUT
                  echo "version=${TAG#v}" >> $GITHUB_OUTPUT
                  echo "Release tag: ${TAG}, version: ${TAG#v}"
